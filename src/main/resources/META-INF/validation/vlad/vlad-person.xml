<?xml version="1.0" encoding="UTF-8"?>
<vlad xmlns:vlad="http://www.sapia-oss.org/vlad/rules">

	<!-- ===============================================================================================================
        PERSON

        com.kosoj.entity.Person

    	PER001 - Code is mandatory
    	PER002 - Gender is mandatory
    	PER003 - Name is mandatory
    	PER004 - Male person code is not valid
    	PER005 - Female person code is not valid
    	PER006 - Birth date is mandatory
    	PER007 - Birth date (age) is not valid
    	PER008 - Contacts min size
    -->
	<ruleSet id="checkPerson">
		<!-- parent -->
		<ruleSetRef id="checkAbstractEntity"/>

		<!-- attributes -->
		<ruleSetRef id="checkPersonCode"/>
		<ruleSetRef id="checkPersonGender"/>
		<ruleSetRef id="checkPersonName"/>
		<ruleSetRef id="checkPersonBirth"/>
		<ruleSetRef id="checkPersonContacts"/>

		<!-- custom part -->
		<ruleSetRef id="checkPersonExtended"/>
	</ruleSet>


	<!-- CUSTOM WRAPPER ============================================================================================ -->
	<ruleSet id="checkPersonExtended">
		<!-- DO NOT PUT ANYTHING HERE -->
	</ruleSet>


	<!-- ATTRIBUTES ================================================================================================ -->

	<!-- code -->
	<ruleSet id="checkPersonCode">
		<vlad:notEmpty attribute="code" id="PER001">
            <message value="MANDATORY;code;Person code is mandatory"/>
		</vlad:notEmpty>
		<vlad:ifNotEmpty attribute="code">
			<ruleSetRef id="checkPersonCodeByGender"/>
		</vlad:ifNotEmpty>
	</ruleSet>

	<!-- gender -->
	<ruleSet id="checkPersonGender">
		<vlad:mandatory attribute="gender" id="PER002">
            <message value="MANDATORY;gender;Gender is mandatory"/>
		</vlad:mandatory>
	</ruleSet>

	<!-- name -->
	<ruleSet id="checkPersonName">
		<vlad:notEmpty attribute="name" id="PER003">
            <message value="MANDATORY;name;Person name is mandatory"/>
		</vlad:notEmpty>
		<vlad:ifNotEmpty attribute="name">
			<vlad:select attribute="name">
				<ruleSetRef id="checkPersonalName"/>
			</vlad:select>
		</vlad:ifNotEmpty>
	</ruleSet>

	<!-- birth -->
	<ruleSet id="checkPersonBirth">
		<vlad:notEmpty attribute="birth" id="PER006">
            <message value="MANDATORY;birth;Birth date is mandatory"/>
		</vlad:notEmpty>
		<vlad:ifNotEmpty attribute="birth">
			<vlad:age attribute="birth" id="PER007" age="18">
				<message value="INVALID;birth;Birth date (age) is not valid (type=${type}, age=${age}, value=${value})"/>
			</vlad:age>
		</vlad:ifNotEmpty>
	</ruleSet>

	<!-- contacts -->
	<ruleSet id="checkPersonContacts">
		<vlad:notEmpty attribute="contacts" id="PER008">
            <message value="MANDATORY;contacts;Person has to have at least one contact"/>
		</vlad:notEmpty>
		<vlad:ifNotEmpty attribute="contacts">
			<ruleSet id="contact">
				<vlad:minSize attribute="contacts" size="1" id="PER008">
					<message value="MIN_SIZE;contacts;Person has to have at least one contact"/>
				</vlad:minSize>
				<vlad:forEach attribute="contacts">
					 <ruleSet id="checkContact" />
				</vlad:forEach>
			</ruleSet>
		</vlad:ifNotEmpty>
	</ruleSet>

	<!-- SPECIAL ================================================================================================ -->
	<ruleSet id="checkPersonCodeByGender">
		<vlad:ifEquals attribute="gender" value="MALE">
			<vlad:regExPlus attribute="code" id="PER004" pattern="^[56789]{2}M[0-9]{4}$">
				<message value="INVALID;code;Person code is not valid (pattern=${pattern}, value=${value})"/>
			</vlad:regExPlus>
		</vlad:ifEquals>
		<vlad:ifEquals attribute="gender" value="FEMALE">
			<vlad:regExPlus attribute="code" id="PER005" pattern="^[01234]{2}F[0-9]{4}$">
				<message value="INVALID;code;Person code is not valid (pattern=${pattern}, value=${value})"/>
			</vlad:regExPlus>
		</vlad:ifEquals>
	</ruleSet>

</vlad>